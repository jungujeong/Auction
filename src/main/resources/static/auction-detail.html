<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경매 상세 - 중고경매</title>
    <link rel="stylesheet" href="/auction/css/style.css">
</head>
<body>
    <div class="navbar">
        <div class="container">
            <a href="/auction/" class="logo">중고경매</a>
            <nav>
                <ul>
                    <li><a href="/auction/">홈</a></li>
                    <li><a href="/auction/items.html">경매 목록</a></li>
                    <li><a href="/auction/register-item.html">물건 등록</a></li>
                    <li id="loginLink"><a href="/auction/login.html">로그인</a></li>
                    <li id="signupLink"><a href="/auction/signup.html">회원가입</a></li>
                    <li id="userInfo" style="display: none;"><span id="usernameDisplay"></span></li>
                    <li id="logoutLink" style="display: none;"><a href="#" onclick="logout()">로그아웃</a></li>
                </ul>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="card mt-4">
            <h2 id="itemTitle">상품 제목</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                <div>
                    <div id="itemImages" style="background: #eee; height: 400px; display: flex; align-items: center; justify-content: center;">
                        이미지 영역
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>카테고리</label>
                        <p id="itemCategory"></p>
                    </div>
                    <div class="form-group">
                        <label>현재가</label>
                        <p id="currentPrice" style="font-size: 1.5rem; color: #e74c3c; font-weight: bold;"></p>
                    </div>
                    <div class="form-group">
                        <label>경매 종료</label>
                        <p id="endTime"></p>
                    </div>
                    <div class="form-group">
                        <label>입찰가</label>
                        <input type="number" id="bidAmount" min="0">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;">입찰하기</button>
                    <button id="deleteButton" class="btn btn-danger" style="width: 100%; margin-top: 0.5rem; display: none;" onclick="deleteItem()">삭제하기</button>
                </div>
            </div>
            <div class="mt-4">
                <h3>상품 설명</h3>
                <p id="itemDescription"></p>
            </div>
            <div class="mt-4">
                <h3>입찰 내역</h3>
                <div id="bidHistory">
                    <!-- 입찰 내역이 여기에 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 중고경매</p>
        </div>
    </footer>

    <script>
        // 페이지 로드 시 로그인 상태 확인
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            if (token && username) {
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('signupLink').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('logoutLink').style.display = 'block';
                document.getElementById('usernameDisplay').textContent = username + '님';
            } else {
                document.getElementById('loginLink').style.display = 'block';
                document.getElementById('signupLink').style.display = 'block';
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('logoutLink').style.display = 'none';
            }
        });

        // 로그아웃
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            alert('로그아웃 되었습니다.');
            window.location.reload();
        }

        // URL에서 아이템 ID 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');

        if (!itemId) {
            alert('잘못된 접근입니다.');
            window.location.href = '/auction/items.html';
        }

        // 아이템 상세 정보 불러오기
        async function loadItemDetail() {
            try {
                const response = await fetch(`/auction/api/items/${itemId}`);

                if (response.ok) {
                    const item = await response.json();
                    displayItemDetail(item);
                } else {
                    alert('상품 정보를 불러오는데 실패했습니다.');
                    window.location.href = '/auction/items.html';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('오류가 발생했습니다.');
            }
        }

        // 아이템 상세 정보 표시
        function displayItemDetail(item) {
            document.getElementById('itemTitle').textContent = item.title;
            document.getElementById('itemCategory').textContent = item.category || '미분류';
            document.getElementById('currentPrice').textContent = formatPrice(item.currentPrice) + '원';
            document.getElementById('endTime').textContent = formatDateTime(item.endTime);
            document.getElementById('itemDescription').textContent = item.description;

            // 이미지 표시
            const imageDiv = document.getElementById('itemImages');
            if (item.imageUrl) {
                imageDiv.innerHTML = `<img src="${item.imageUrl}" alt="${item.title}" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                imageDiv.innerHTML = '<p>이미지 없음</p>';
            }

            // 입찰가 최소값 설정 (현재가 + 1000원)
            document.getElementById('bidAmount').min = item.currentPrice + 1000;
            document.getElementById('bidAmount').value = item.currentPrice + 1000;

            // 본인이 등록한 물건인지 확인하여 삭제 버튼 표시
            const username = localStorage.getItem('username');
            if (username && item.sellerName === username) {
                document.getElementById('deleteButton').style.display = 'block';
            }
        }

        // 물건 삭제
        async function deleteItem() {
            if (!confirm('정말 삭제하시겠습니까?')) {
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                alert('로그인이 필요합니다.');
                window.location.href = '/auction/login.html';
                return;
            }

            try {
                const response = await fetch(`/auction/api/items/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    alert('물건이 삭제되었습니다.');
                    window.location.href = '/auction/items.html';
                } else {
                    const error = await response.text();
                    alert('삭제 실패: ' + error);
                }
            } catch (error) {
                alert('오류가 발생했습니다: ' + error);
            }
        }

        // 가격 포맷팅
        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // 날짜 포맷팅
        function formatDateTime(dateTime) {
            const date = new Date(dateTime);
            return date.toLocaleString('ko-KR');
        }

        // 페이지 로드 시 실행
        window.addEventListener('DOMContentLoaded', loadItemDetail);
    </script>
</body>
</html>
