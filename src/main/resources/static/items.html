<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경매 목록 - 중고경매</title>
    <link rel="stylesheet" href="/auction/css/style.css">
</head>
<body>
    <div class="navbar">
        <div class="container">
            <a href="/auction/" class="logo">중고경매</a>
            <nav>
                <ul>
                    <li><a href="/auction/">홈</a></li>
                    <li><a href="/auction/items.html">경매 목록</a></li>
                    <li><a href="/auction/register-item.html">물건 등록</a></li>
                    <li id="loginLink"><a href="/auction/login.html">로그인</a></li>
                    <li id="signupLink"><a href="/auction/signup.html">회원가입</a></li>
                    <li id="userInfo" style="display: none;"><span id="usernameDisplay"></span></li>
                    <li id="logoutLink" style="display: none;"><a href="#" onclick="logout()">로그아웃</a></li>
                </ul>
            </nav>
        </div>
    </div>

    <div class="container">
        <h1 class="section-title mt-4">경매 목록</h1>

        <div class="grid" id="itemList">
            <p class="text-center">경매 목록을 불러오는 중...</p>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 중고경매</p>
        </div>
    </footer>

    <script>
        // 페이지 로드 시 로그인 상태 확인
        let currentUsername = null;

        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            if (token && username) {
                currentUsername = username;
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('signupLink').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('logoutLink').style.display = 'block';
                document.getElementById('usernameDisplay').textContent = username + '님';
            } else {
                document.getElementById('loginLink').style.display = 'block';
                document.getElementById('signupLink').style.display = 'block';
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('logoutLink').style.display = 'none';
            }
        });

        // 로그아웃
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            alert('로그아웃 되었습니다.');
            window.location.reload();
        }

        // 경매 목록 불러오기
        async function loadItems() {
            try {
                const response = await fetch('/auction/api/items/active');

                if (response.ok) {
                    const items = await response.json();
                    displayItems(items);
                } else {
                    document.getElementById('itemList').innerHTML =
                        '<p class="text-center">경매 목록을 불러오는데 실패했습니다.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('itemList').innerHTML =
                    '<p class="text-center">오류가 발생했습니다.</p>';
            }
        }

        // 경매 목록 표시
        function displayItems(items) {
            const itemList = document.getElementById('itemList');

            if (items.length === 0) {
                itemList.innerHTML = '<p class="text-center">등록된 경매가 없습니다.</p>';
                return;
            }

            itemList.innerHTML = items.map(item => {
                // 본인이 등록한 물건인지 확인
                const isMine = currentUsername && item.sellerName === currentUsername;

                return `
                    <div class="item-card">
                        <img src="${item.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}"
                             alt="${item.title}">
                        <div class="item-card-content">
                            <h3>${item.title}</h3>
                            <p class="price">${formatPrice(item.currentPrice)}원</p>
                            <p class="meta">
                                시작가: ${formatPrice(item.startPrice)}원<br>
                                판매자: ${item.sellerName}<br>
                                종료: ${formatDateTime(item.endTime)}
                            </p>
                            <span class="status ${item.status.toLowerCase()}">${getStatusText(item.status)}</span>
                            <a href="/auction/auction-detail.html?id=${item.id}" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">상세보기</a>
                            ${isMine ? `<button onclick="deleteItem(${item.id})" class="btn btn-danger" style="width: 100%; margin-top: 0.5rem;">삭제하기</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 물건 삭제
        async function deleteItem(itemId) {
            if (!confirm('정말 삭제하시겠습니까?')) {
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                alert('로그인이 필요합니다.');
                return;
            }

            try {
                const response = await fetch(`/auction/api/items/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    alert('물건이 삭제되었습니다.');
                    loadItems(); // 목록 새로고침
                } else {
                    const error = await response.text();
                    alert('삭제 실패: ' + error);
                }
            } catch (error) {
                alert('오류가 발생했습니다: ' + error);
            }
        }

        // 가격 포맷팅
        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // 날짜 포맷팅
        function formatDateTime(dateTime) {
            const date = new Date(dateTime);
            return date.toLocaleString('ko-KR');
        }

        // 상태 텍스트
        function getStatusText(status) {
            const statusMap = {
                'ACTIVE': '진행중',
                'ENDED': '종료',
                'SOLD': '판매완료'
            };
            return statusMap[status] || status;
        }

        // 페이지 로드 시 실행
        window.addEventListener('DOMContentLoaded', loadItems);
    </script>
</body>
</html>
