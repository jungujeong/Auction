<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head('프로필 - 중고경매')}"></head>
<body>
    <div th:replace="~{fragments/layout :: navbar}"></div>

    <div class="container">
        <div class="form-container mt-4">
            <h1 class="section-title">내 프로필</h1>

            <form id="profileForm">
                <div class="form-group">
                    <label for="username">아이디</label>
                    <input type="text" id="username" th:value="${user.username}" readonly
                           style="background-color: #e9ecef; cursor: not-allowed;">
                    <small>아이디는 변경할 수 없습니다.</small>
                </div>

                <div class="form-group">
                    <label for="email">이메일 *</label>
                    <input type="email" id="email" name="email" th:value="${user.email}" required>
                </div>

                <div class="form-group">
                    <label for="name">이름</label>
                    <input type="text" id="name" th:value="${user.name}" readonly
                           style="background-color: #e9ecef; cursor: not-allowed;">
                    <small>이름은 변경할 수 없습니다.</small>
                </div>

                <hr style="margin: 2rem 0; border: none; border-top: 1px solid #dee2e6;">

                <h3 style="font-size: 1.25rem; font-weight: 600; color: #212529; margin-bottom: 1.5rem;">비밀번호 변경</h3>
                <small style="display: block; color: #6c757d; margin-bottom: 1rem;">비밀번호를 변경하지 않으려면 아래 필드를 비워두세요.</small>

                <div class="form-group">
                    <label for="currentPassword">현재 비밀번호</label>
                    <input type="password" id="currentPassword" name="currentPassword">
                    <small>비밀번호를 변경하려면 현재 비밀번호를 입력하세요.</small>
                </div>

                <div class="form-group">
                    <label for="newPassword">새 비밀번호</label>
                    <input type="password" id="newPassword" name="newPassword">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">새 비밀번호 확인</label>
                    <input type="password" id="confirmPassword" name="confirmPassword">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">저장하기</button>
                    <a th:href="@{/}" class="btn btn-secondary">취소</a>
                </div>
            </form>
        </div>
    </div>

    <footer th:replace="~{fragments/layout :: footer}"></footer>

    <script th:inline="javascript">
        const contextPath = /*[[@{/}]]*/ '';
        const basePath = contextPath.endsWith('/') ? contextPath.slice(0, -1) : contextPath;

        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const currentPassword = document.getElementById('currentPassword').value;

            // 비밀번호 변경 시 검증
            if (newPassword || confirmPassword || currentPassword) {
                if (!currentPassword) {
                    alert('현재 비밀번호를 입력하세요.');
                    return;
                }
                if (!newPassword) {
                    alert('새 비밀번호를 입력하세요.');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('새 비밀번호가 일치하지 않습니다.');
                    return;
                }
                if (newPassword.length < 4) {
                    alert('비밀번호는 최소 4자 이상이어야 합니다.');
                    return;
                }
            }

            const profileData = {
                email: document.getElementById('email').value,
                currentPassword: currentPassword || null,
                newPassword: newPassword || null
            };

            try {
                const response = await fetch(basePath + '/api/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });

                if (response.ok) {
                    alert('프로필이 수정되었습니다.');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('수정 실패: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('오류가 발생했습니다.');
            }
        });
    </script>
</body>
</html>
