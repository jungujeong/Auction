<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head(#{register.title} + ' - ' + #{app.title})}"></head>
<body>
    <div th:replace="~{fragments/layout :: navbar}"></div>

    <div class="container">
        <div class="form-container mt-4">
            <h1 class="section-title" th:text="#{register.title}">ë¬¼ê±´ ë“±ë¡</h1>

            <form id="registerForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="title"><span th:text="#{register.item.title}">ì œëª©</span> *</label>
                    <input type="text" id="title" name="title" required>
                </div>

                <div class="form-group">
                    <label for="description"><span th:text="#{register.description}">ì„¤ëª…</span> *</label>
                    <textarea id="description" name="description" rows="5" required></textarea>
                </div>

                <!-- AI ê°€ê²© ì¶”ì²œ ë²„íŠ¼ -->
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" onclick="getPriceRecommendation()" style="width: 100%;">
                        ğŸ’¡ AI ê°€ê²© ì¶”ì²œ ë°›ê¸°
                    </button>
                    <div id="priceRecommendation" style="display: none; margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 8px; border: 1px solid #2196f3;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #1976d2; font-size: 1rem;">ì¶”ì²œ ê°€ê²© ì •ë³´</h4>
                        <p id="recommendationMessage" style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;"></p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                            <div><strong>ì¶”ì²œ ì‹œì‘ê°€:</strong> <span id="recommendedPrice" style="color: #d32f2f; font-weight: bold;"></span></div>
                            <div><strong>í‰ê· ê°€:</strong> <span id="averagePrice"></span></div>
                            <div><strong>ìµœì €ê°€:</strong> <span id="minPrice"></span></div>
                            <div><strong>ìµœê³ ê°€:</strong> <span id="maxPrice"></span></div>
                        </div>
                        <button type="button" onclick="applyRecommendedPrice()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                            ì¶”ì²œê°€ ì ìš©í•˜ê¸°
                        </button>
                    </div>
                    <div id="priceRecommendationError" style="display: none; margin-top: 1rem; padding: 1rem; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; color: #c62828;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="startPrice"><span th:text="#{register.start.price.hint}">ì‹œì‘ê°€ (ì›)</span> *</label>
                    <input type="number" id="startPrice" name="startPrice" min="0" required>
                </div>

                <div class="form-group">
                    <label for="endTime"><span th:text="#{register.end.time}">ì¢…ë£Œ ì¼ì‹œ</span> *</label>
                    <input type="datetime-local" id="endTime" name="endTime" required>
                </div>

                <div class="form-group">
                    <label for="image" th:text="#{register.image}">ì´ë¯¸ì§€</label>
                    <input type="file" id="image" name="image" accept="image/*" onchange="previewImage(event)">
                    <div id="imagePreview" style="margin-top: 1rem; display: none;">
                        <img id="preview" src="" th:alt="#{register.image.preview}" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" th:text="#{register.submit}">ë“±ë¡í•˜ê¸°</button>
                    <a th:href="@{/}" class="btn btn-secondary" th:text="#{register.cancel}">ì·¨ì†Œ</a>
                </div>
            </form>
        </div>
    </div>

    <footer th:replace="~{fragments/layout :: footer}"></footer>

    <script th:inline="javascript">
        // i18n ë©”ì‹œì§€ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì „ë‹¬
        const i18n = {
            success: /*[[#{register.success}]]*/ 'ë¬¼ê±´ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
            error: /*[[#{register.error}]]*/ 'ë“±ë¡ ì‹¤íŒ¨',
            imageUploadError: /*[[#{register.image.upload.error}]]*/ 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
            imageUploadException: /*[[#{register.image.upload.exception}]]*/ 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
            exception: /*[[#{register.exception}]]*/ 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        };

        const contextPath = /*[[@{/}]]*/ '';
        // contextPathì—ëŠ” ì´ë¯¸ '/auction/'ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë§ˆì§€ë§‰ /ë¥¼ ì œê±°
        const basePath = contextPath.endsWith('/') ? contextPath.slice(0, -1) : contextPath;

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('preview');
            const previewContainer = document.getElementById('imagePreview');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                previewContainer.style.display = 'none';
            }
        }

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const imageFile = document.getElementById('image').files[0];
            let imageUrl = null;

            // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì—…ë¡œë“œ
            if (imageFile) {
                const formData = new FormData();
                formData.append('file', imageFile);

                try {
                    const uploadResponse = await fetch(basePath + '/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const result = await uploadResponse.json();
                        imageUrl = result.url;
                    } else {
                        alert(i18n.imageUploadError);
                        return;
                    }
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert(i18n.imageUploadException);
                    return;
                }
            }

            // ë¬¼ê±´ ë“±ë¡
            const itemData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                startPrice: parseInt(document.getElementById('startPrice').value),
                endTime: document.getElementById('endTime').value,
                imageUrl: imageUrl
            };

            try {
                const response = await fetch(basePath + '/api/items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(itemData)
                });

                if (response.ok) {
                    alert(i18n.success);
                    window.location.href = basePath + '/items';
                } else {
                    const error = await response.text();
                    alert(i18n.error + ': ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert(i18n.exception);
            }
        });

        // ì¢…ë£Œì¼ì‹œ ìµœì†Œê°’ì„ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('endTime').min = now.toISOString().slice(0, 16);

        // ê°€ê²© ì¶”ì²œ ë°ì´í„° ì €ì¥
        let recommendationData = null;

        // AI ê°€ê²© ì¶”ì²œ ë°›ê¸°
        async function getPriceRecommendation() {
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();

            if (!title) {
                alert('ì œëª©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = 'â³ ë¶„ì„ ì¤‘...';
            button.disabled = true;

            // ì´ì „ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.getElementById('priceRecommendation').style.display = 'none';
            document.getElementById('priceRecommendationError').style.display = 'none';

            try {
                const response = await fetch('http://localhost:5000/api/recommend-price', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        description: description
                    })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    recommendationData = result.data;

                    // ê²°ê³¼ í‘œì‹œ
                    document.getElementById('recommendationMessage').textContent = result.data.message;
                    document.getElementById('recommendedPrice').textContent = formatPrice(result.data.recommended_price);
                    document.getElementById('averagePrice').textContent = formatPrice(result.data.average_price);
                    document.getElementById('minPrice').textContent = formatPrice(result.data.min_price);
                    document.getElementById('maxPrice').textContent = formatPrice(result.data.max_price);

                    document.getElementById('priceRecommendation').style.display = 'block';
                } else {
                    showError(result.error || 'ê°€ê²© ì¶”ì²œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('ê°€ê²© ì¶”ì²œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Python ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // ì¶”ì²œê°€ ì ìš©
        function applyRecommendedPrice() {
            if (recommendationData && recommendationData.recommended_price > 0) {
                document.getElementById('startPrice').value = recommendationData.recommended_price;
                alert('ì¶”ì²œ ì‹œì‘ê°€ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ê°€ê²© í¬ë§·íŒ…
        function formatPrice(price) {
            return price.toLocaleString('ko-KR') + 'ì›';
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            const errorDiv = document.getElementById('priceRecommendationError');
            errorDiv.textContent = 'âš ï¸ ' + message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>
