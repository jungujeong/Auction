<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head(#{register.title} + ' - ' + #{app.title})}"></head>
<body>
    <div th:replace="~{fragments/layout :: navbar}"></div>

    <div class="container">
        <div class="form-container mt-4">
            <h1 class="section-title" th:text="#{register.title}">물건 등록</h1>

            <form id="registerForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="title"><span th:text="#{register.item.title}">제목</span> *</label>
                    <input type="text" id="title" name="title" required>
                </div>

                <div class="form-group">
                    <label for="description"><span th:text="#{register.description}">설명</span> *</label>
                    <textarea id="description" name="description" rows="5" required></textarea>
                </div>

                <div class="form-group">
                    <label for="startPrice"><span th:text="#{register.start.price.hint}">시작가 (원)</span> *</label>
                    <input type="number" id="startPrice" name="startPrice" min="0" required>
                </div>

                <div class="form-group">
                    <label for="endTime"><span th:text="#{register.end.time}">종료 일시</span> *</label>
                    <input type="datetime-local" id="endTime" name="endTime" required>
                </div>

                <div class="form-group">
                    <label for="image" th:text="#{register.image}">이미지</label>
                    <input type="file" id="image" name="image" accept="image/*" onchange="previewImage(event)">
                    <div id="imagePreview" style="margin-top: 1rem; display: none;">
                        <img id="preview" src="" th:alt="#{register.image.preview}" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" th:text="#{register.submit}">등록하기</button>
                    <a th:href="@{/}" class="btn btn-secondary" th:text="#{register.cancel}">취소</a>
                </div>
            </form>
        </div>
    </div>

    <footer th:replace="~{fragments/layout :: footer}"></footer>

    <script th:inline="javascript">
        // i18n 메시지를 JavaScript 변수로 전달
        const i18n = {
            success: /*[[#{register.success}]]*/ '물건이 등록되었습니다.',
            error: /*[[#{register.error}]]*/ '등록 실패',
            imageUploadError: /*[[#{register.image.upload.error}]]*/ '이미지 업로드에 실패했습니다.',
            imageUploadException: /*[[#{register.image.upload.exception}]]*/ '이미지 업로드 중 오류가 발생했습니다.',
            exception: /*[[#{register.exception}]]*/ '오류가 발생했습니다.'
        };

        const contextPath = /*[[@{/}]]*/ '';
        // contextPath에는 이미 '/auction/'이 포함되어 있으므로 마지막 /를 제거
        const basePath = contextPath.endsWith('/') ? contextPath.slice(0, -1) : contextPath;

        // 이미지 미리보기
        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('preview');
            const previewContainer = document.getElementById('imagePreview');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                previewContainer.style.display = 'none';
            }
        }

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const imageFile = document.getElementById('image').files[0];
            let imageUrl = null;

            // 이미지가 있으면 먼저 업로드
            if (imageFile) {
                const formData = new FormData();
                formData.append('file', imageFile);

                try {
                    const uploadResponse = await fetch(basePath + '/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const result = await uploadResponse.json();
                        imageUrl = result.url;
                    } else {
                        alert(i18n.imageUploadError);
                        return;
                    }
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert(i18n.imageUploadException);
                    return;
                }
            }

            // 물건 등록
            const itemData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                startPrice: parseInt(document.getElementById('startPrice').value),
                endTime: document.getElementById('endTime').value,
                imageUrl: imageUrl
            };

            try {
                const response = await fetch(basePath + '/api/items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(itemData)
                });

                if (response.ok) {
                    alert(i18n.success);
                    window.location.href = basePath + '/items';
                } else {
                    const error = await response.text();
                    alert(i18n.error + ': ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert(i18n.exception);
            }
        });

        // 종료일시 최소값을 현재 시간으로 설정
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('endTime').min = now.toISOString().slice(0, 16);
    </script>
</body>
</html>
